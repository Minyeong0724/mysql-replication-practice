# MySQL-Replication-Formats 실습

Docker 환경에서 MySQL Source-Replica 복제 아키텍처를 구축하고, 복제 포맷(SBR, RBR, MBR)에 따른 Binary Log의 내부 데이터 구조를 분석한다.

## Replication Formats

### SBR (Statement-Based Replication)
- 실행된 SQL 문을 그대로 기록하는 방식이다. 로그 파일 크기가 작다.

- 한계: `NOW()`, `UUID()` 같은 비확정적 함수 사용 시 소스-레플리카 간 데이터가 불일치할 위험이 존재한다.

- 확인 방법
: `SHOW BINLOG EVENTS` 명령을 통해 `Event_type`이 `Query`인 것을 확인한다.

```bash
SHOW BINLOG EVENTS;
```

```bash
| Log_name         | Pos  | Event_type     | Server_id | End_log_pos | Info 
| mysql-bin.000001 |  237 | Query          |         1 |         472 | CREATE USER 'yeong'@'%' IDENTIFIED WITH 'caching_sha2_password' AS '$A$00A$XqLs\"3u^[<Onei8XzpLFct5NMq4uWvVhR9.V8bg3Hjt0SK.CEBGAs6cQ1' /* xid=5 */ |
```
다음과 같이 `CREATE`, `ALTER`, `DROP`, `TRUNCATE` 등의 데이터 정의어(DDL)는 문장 자체로 구조가 확정되므로 SBR 방식으로 기록된다.

<details>
<summary> ALTER, DROP, TRUNCATE </summary>

- SQL 

```bash
ALTER TABLE products ADD COLUMN price INT DEFAULT 0;
CREATE TABLE temp_logs (id INT);
TRUNCATE TABLE temp_logs;
DROP TABLE temp_logs;
```
- 결과

```bash
SHOW BINLOG EVENTS;
```

```bash
| Log_name         | Pos  | Event_type     | Server_id | End_log_pos | Info                                                       
| mysql-bin.000001 | 2544 | Query          |         1 |        2687 | use `testdb`; alter table products add column price int default 0 /* xid=78 */  
| mysql-bin.000001 | 2764 | Query          |         1 |        2887 | use `testdb`; create table temp_logs (id INT) /* xid=79 */    
| mysql-bin.000001 | 2964 | Query          |         1 |        3069 | use `testdb`; truncate table temp_logs /* xid=80 */   
| mysql-bin.000001 | 3146 | Query          |         1 |        3284 | use `testdb`; DROP TABLE `temp_logs` /* generated by server */ /* xid=81 */   
```
</details>

### RBR(Row-Based Repliacation)

- 변경된 행(Row)의 실제 데이터 값을 바이너리로 기록한다. 데이터 무결성을 보장한다.

- 한계: 대량의 데이터 변경(예: 수백만 건의 UPDATE/DELETE) 발생 시 로그 파일의 크기가 SBR에 비해 급격히 증가할 수 있다.

- 확인 방법
: SHOW BINLOG EVENTS 명령을 통해 Event_type이 `Write_rows`, `Update_rows`, `Delete_rows` 인 것을 확인한다.


```bash
SHOW BINLOG EVENTS;
```
```bash
| Log_name         | Pos  | Event_type     | Server_id | End_log_pos | Info 
| mysql-bin.000001 | 1478 | Write_rows     |         1 |        1520 | table_id: 93 flags: STMT_END_F USE_SQL_FOREIGN_KEY_F                             
```
다음과 같이 `INSERT`, `UPDATE`, `DELETE` 등의 데이터 조작어(DML)는 실행 시점에 따라 결과가 달라질 위험이 있으므로, 최종 결정된 데이터 값만 로그로 남긴다.

- Write_rows 기반 쿼리 복원 방법
```bash
docker exec -it mysql-source /usr/libexec/mysqlsh/mysqlbinlog --no-defaults -v --base64-output=DECODE-ROWS /var/lib/mysql/mysql-bin.000001

```

```bash
# at 1478
#260223  1:43:38 server id 1  end_log_pos 1520 CRC32 0xdd34c367         Write_rows: table id 93 flags: STMT_END_F USE_SQL_FOREIGN_KEY_F
### INSERT INTO `testdb`.`products`
### SET
###   @1='apple'
```
다음과 같이 binary log에 기록되어있는 설정값을  토대로 INSERT 쿼리문을 복원해낼 수 있다. 

<details>
<summary> UPDATE, DELETE </summary>

- SQL

```bash
UPDATE products SET text = 'updated product' WHERE text = 'new product';
DELETE FROM products WHERE text = 'updated product';
```
- 실행 결과
```bash
SHOW BINLOG EVENTS;
```
```bash
| Log_name         | Pos  | Event_type     | Server_id | End_log_pos | Info    
| mysql-bin.000001 | 2071 | Update_rows    |         1 |        2137 | table_id: 93 flags: STMT_END_F USE_SQL_FOREIGN_KEY_F    
| mysql-bin.000001 | 2384 | Delete_rows    |         1 |        2436 | table_id: 93 flags: STMT_END_F USE_SQL_FOREIGN_KEY_F   
```

</details>

### MBR(Mixed-Based Replication)

기본적으로는 SBR 방식을 사용하되, 정합성 오류가 발생할 가능성이 있는 특정 쿼리(함수 사용 등)에 대해서만 자동으로 RBR 방식으로 기록하는 혼합형 방식이다.

## Binary Log
Binary Log는 MySQL 서버에서 발생하는 모든 변경 사항(DDL, DML)을 순서대로 기록한 바이너리 파일이다. 복제 시 Source 서버의 데이터를 Replica 서버로 전달하거나, 데이터가 손실되었을 때 특정 시점으로 복구하기 위한 용도로 사용된다. 

### 1. Binary Log 필드 상세 설명

| 필드명 | 설명 | 비고 |
| :--- | :--- | :--- |
| **Log_name** | 현재 이벤트가 기록된 바이너리 로그 파일의 이름 | mysql-bin.000001 등 |
| **Pos** | 이벤트가 시작되는 파일 내 바이트 위치 | 시작 지점 |
| **Event_type** | 기록된 이벤트의 종류 | Query, Write_rows, Gtid 등 |
| **Server_id** | 이벤트를 생성한 서버의 고유 식별 번호 | Source=1, Replica=2 등 |
| **End_log_pos** | 이벤트가 종료되는 지점의 위치 | 다음 이벤트의 Pos와 동일 |
| **Info** | 이벤트의 상세 내용 (SQL문 또는 테이블 정보) | RBR의 경우 디코딩 필요 |

---

### 2. 식별자 및 플래그 요약

| 구분 | 항목 | 주요 역할 |
| :---: | :--- | :--- |
| **식별자** | `GTID` | 복제 토폴로지 내의 모든 서버에서 트랜잭션을 고유하게 식별하기 위해 할당되는 전역 식별자. 소스 서버에서 발행되어 복제본까지 동일하게 유지되며, 장애 복구(Failover) 시 데이터 일관성 지점으로 활용된다. |
| **식별자** | `XID` | MySQL 상위 엔진과 하위 스토리지 엔진(InnoDB) 간의 트랜잭션 원자성(Atomicity)을 보장하기 위한 내부 식별자. 2단계 커밋(2-Phase Commit) 과정에서 바이너리 로그와 엔진 간의 데이터 대조값으로 사용된다. |
| **플래그** | `STMT_END_F` | 현재의 바이너리 로그 이벤트가 해당 SQL 문장의 데이터 전송 단위 중 마지막 지점임을 명시하는 상태 플래그 |
| **플래그** | `USE_SQL_FOREIGN_KEY_F` | 트랜잭션 실행 당시 소스 서버의 외래 키 제약 조건 확인(foreign_key_checks) 설정 상태를 기록한 플래그. 복제본에서 소스와 동일한 무결성 검사 환경을 재현하는 데 사용된다. |
